{% extends "base.html" %}

{% block title %}Upload Routes - HPCL Route Management{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4><i class="fas fa-upload"></i> Upload Route CSV</h4>
            </div>
            <div class="card-body">
                <form id="uploadForm" method="POST" action="{{ url_for('upload') }}" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="csv_file" class="form-label">Select CSV File</label>
                        <input type="file" class="form-control" id="csv_file" name="csv_file" 
                               accept=".csv" required>
                        <div class="form-text">
                            CSV should contain: BU Code, Row Labels, Customer Name, Location
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <h6>CSV Format Requirements:</h6>
                        <ul>
                            <li>Column 1: BU Code (From location code)</li>
                            <li>Column 2: Row Labels (To location code)</li>
                            <li>Column 3: Customer Name</li>
                            <li>Column 4: Location</li>
                        </ul>
                        <p class="mb-0">
                            Coordinate files should be in route_data folder named as: 
                            <code>BUCode_RowLabels.xlsx</code>
                        </p>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary" id="uploadBtn">
                            <i class="fas fa-upload"></i> Upload and Process
                        </button>
                    </div>
                </form>
                
                <!-- Progress Section (Hidden by default) -->
                <div id="progressSection" style="display: none;" class="mt-4">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-spinner fa-spin"></i> Processing Routes
                            </h5>
                            
                            <!-- Main Progress Bar -->
                            <div class="mb-3">
                                <label class="form-label">Overall Progress</label>
                                <div class="progress" style="height: 30px;">
                                    <div id="mainProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                         role="progressbar" style="width: 0%">
                                        <span id="mainProgressText">0%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Statistics Grid -->
                            <div class="row text-center mb-3">
                                <div class="col-md-3">
                                    <div class="card border-primary">
                                        <div class="card-body p-2">
                                            <h6 class="card-subtitle mb-1 text-muted">Total Routes</h6>
                                            <h4 id="totalRoutes" class="mb-0">0</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-success">
                                        <div class="card-body p-2">
                                            <h6 class="card-subtitle mb-1 text-muted">Processed</h6>
                                            <h4 id="processedRoutes" class="mb-0 text-success">0</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-warning">
                                        <div class="card-body p-2">
                                            <h6 class="card-subtitle mb-1 text-muted">Skipped</h6>
                                            <h4 id="skippedRoutes" class="mb-0 text-warning">0</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-danger">
                                        <div class="card-body p-2">
                                            <h6 class="card-subtitle mb-1 text-muted">Failed</h6>
                                            <h4 id="failedRoutes" class="mb-0 text-danger">0</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Current Route Progress -->
                            <div class="mb-3">
                                <label class="form-label">Current Route: <span id="currentRouteName" class="text-primary">-</span></label>
                                <div class="progress" style="height: 20px;">
                                    <div id="routeProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                                         role="progressbar" style="width: 0%">
                                        <span id="routeProgressText">Initializing...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Processing Log -->
                            <div class="card">
                                <div class="card-header py-2">
                                    <h6 class="mb-0">Processing Log</h6>
                                </div>
                                <div class="card-body p-2" style="max-height: 200px; overflow-y: auto;">
                                    <div id="processingLog" class="small">
                                        <!-- Log entries will be added here -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Time Statistics -->
                            <div class="row mt-3 text-center">
                                <div class="col-md-4">
                                    <small class="text-muted">Elapsed Time</small>
                                    <p class="mb-0 font-weight-bold" id="elapsedTime">00:00</p>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted">Estimated Time Remaining</small>
                                    <p class="mb-0 font-weight-bold" id="remainingTime">Calculating...</p>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted">Processing Speed</small>
                                    <p class="mb-0 font-weight-bold" id="processingSpeed">0 routes/min</p>
                                </div>
                            </div>
                            
                            <!-- API Call Statistics -->
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6>API Usage</h6>
                                    <div class="row text-center">
                                        <div class="col-md-3">
                                            <small class="text-muted">Weather API</small>
                                            <p class="mb-0" id="weatherApiCalls">0</p>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted">Traffic API</small>
                                            <p class="mb-0" id="trafficApiCalls">0</p>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted">Overpass API</small>
                                            <p class="mb-0" id="overpassApiCalls">0</p>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted">Cache Hits</small>
                                            <p class="mb-0" id="cacheHits">0</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="mt-3 text-center">
                        <button id="pauseBtn" class="btn btn-warning" style="display: none;">
                            <i class="fas fa-pause"></i> Pause Processing
                        </button>
                        <button id="cancelBtn" class="btn btn-danger">
                            <i class="fas fa-stop"></i> Cancel Processing
                        </button>
                    </div>
                </div>
                
                <!-- Results Section (Hidden by default) -->
                <div id="resultsSection" style="display: none;" class="mt-4">
                    <div class="alert alert-success">
                        <h5 class="alert-heading">
                            <i class="fas fa-check-circle"></i> Processing Complete!
                        </h5>
                        <hr>
                        <div id="finalStats">
                            <!-- Final statistics will be shown here -->
                        </div>
                        <div class="mt-3">
                            <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
                                <i class="fas fa-tachometer-alt"></i> Go to Dashboard
                            </a>
                            <button id="uploadAnotherBtn" class="btn btn-secondary">
                                <i class="fas fa-plus"></i> Upload Another File
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Error Section (Hidden by default) -->
                <div id="errorSection" style="display: none;" class="mt-4">
                    <div class="alert alert-danger">
                        <h5 class="alert-heading">
                            <i class="fas fa-exclamation-triangle"></i> Processing Error
                        </h5>
                        <hr>
                        <p id="errorMessage"></p>
                        <div class="mt-3">
                            <button id="retryBtn" class="btn btn-warning">
                                <i class="fas fa-redo"></i> Retry Upload
                            </button>
                            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back to Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let uploadInterval;
    let apiStatsInterval;
    let startTime;
    let processedCount = 0;
    let totalCount = 0;
    let isPaused = false;
    let currentUploadId = null;
    
    // Handle form submission
    $('#uploadForm').on('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const fileInput = $('#csv_file')[0];
        
        if (!fileInput.files.length) {
            alert('Please select a CSV file');
            return;
        }
        
        // Show progress section, hide form
        $('#uploadForm').hide();
        $('#progressSection').show();
        $('#resultsSection').hide();
        $('#errorSection').hide();
        
        // Initialize progress tracking
        startTime = new Date();
        processedCount = 0;
        totalCount = 0;
        
        // Reset API stats
        $('#weatherApiCalls').text('0');
        $('#trafficApiCalls').text('0');
        $('#overpassApiCalls').text('0');
        $('#cacheHits').text('0');
        
        // Start upload
        $.ajax({
            url: '/api/upload/start',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    currentUploadId = response.upload_id;
                    totalCount = response.total_routes;
                    $('#totalRoutes').text(totalCount);
                    
                    // Start polling for progress
                    uploadInterval = setInterval(checkUploadProgress, 1000);
                    
                    // Start API stats polling
                    apiStatsInterval = setInterval(updateApiStats, 5000);
                    
                    // Start time tracking
                    setInterval(updateTimeStats, 1000);
                    
                    addLogEntry('info', `Started processing ${totalCount} routes`);
                } else {
                    showError(response.message || 'Failed to start upload');
                }
            },
            error: function(xhr) {
                showError('Upload failed: ' + (xhr.responseJSON?.message || 'Unknown error'));
            }
        });
    });
    
    // Check upload progress
    function checkUploadProgress() {
        if (isPaused || !currentUploadId) return;
        
        $.ajax({
            url: `/api/upload/progress/${currentUploadId}`,
            method: 'GET',
            success: function(response) {
                updateProgress(response);
                
                if (response.status === 'completed') {
                    clearInterval(uploadInterval);
                    clearInterval(apiStatsInterval);
                    showResults(response);
                } else if (response.status === 'failed') {
                    clearInterval(uploadInterval);
                    clearInterval(apiStatsInterval);
                    showError(response.error || 'Processing failed');
                }
            },
            error: function() {
                console.error('Failed to get progress update');
            }
        });
    }
    
    // Update API statistics
    function updateApiStats() {
        $.ajax({
            url: '/api/statistics',
            method: 'GET',
            success: function(response) {
                if (response.api_call_counts) {
                    response.api_call_counts.forEach(function(api) {
                        switch(api._id) {
                            case 'visualcrossing':
                                $('#weatherApiCalls').text(api.count);
                                break;
                            case 'tomtom':
                                $('#trafficApiCalls').text(api.count);
                                break;
                            case 'overpass':
                                $('#overpassApiCalls').text(api.count);
                                break;
                        }
                    });
                }
            }
        });
    }
    
    // Update progress displays
    function updateProgress(data) {
        // Update counts
        $('#processedRoutes').text(data.processed || 0);
        $('#skippedRoutes').text(data.skipped || 0);
        $('#failedRoutes').text(data.failed || 0);
        
        processedCount = (data.processed || 0) + (data.skipped || 0) + (data.failed || 0);
        
        // Update main progress bar
        const percentage = totalCount > 0 ? Math.round((processedCount / totalCount) * 100) : 0;
        $('#mainProgressBar').css('width', percentage + '%');
        $('#mainProgressText').text(percentage + '%');
        
        // Update current route info
        if (data.current_route) {
            $('#currentRouteName').text(data.current_route.name);
            
            // Update route progress based on stage
            const routeStages = {
                'processing': 10,
                'analyzing_geometry': 20,
                'fetching_services': 40,
                'analyzing_conditions': 60,
                'calculating_risks': 80,
                'saving_data': 100
            };
            
            const routeProgress = routeStages[data.current_route.stage] || 50;
            $('#routeProgressBar').css('width', routeProgress + '%');
            $('#routeProgressText').text(data.current_route.stage_text || 'Processing...');
        }
        
        // Add log entries for completed routes
        if (data.last_completed) {
            const route = data.last_completed;
            const status = route.status === 'completed' ? 'success' : 
                          route.status === 'skipped' ? 'warning' : 'danger';
            const icon = route.status === 'completed' ? 'check' : 
                        route.status === 'skipped' ? 'forward' : 'times';
            
            addLogEntry(status, `<i class="fas fa-${icon}"></i> ${route.name}: ${route.message}`);
        }
    }
    
    // Update time statistics
    function updateTimeStats() {
        if (!startTime) return;
        
        const elapsed = new Date() - startTime;
        const elapsedMinutes = elapsed / 60000;
        
        // Format elapsed time
        const hours = Math.floor(elapsedMinutes / 60);
        const minutes = Math.floor(elapsedMinutes % 60);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        
        $('#elapsedTime').text(
            (hours > 0 ? hours + ':' : '') + 
            String(minutes).padStart(2, '0') + ':' + 
            String(seconds).padStart(2, '0')
        );
        
        // Calculate processing speed
        if (processedCount > 0 && elapsedMinutes > 0) {
            const speed = (processedCount / elapsedMinutes).toFixed(1);
            $('#processingSpeed').text(speed + ' routes/min');
            
            // Estimate remaining time
            const remaining = totalCount - processedCount;
            const estimatedMinutes = remaining / (processedCount / elapsedMinutes);
            
            if (estimatedMinutes < 60) {
                $('#remainingTime').text(Math.ceil(estimatedMinutes) + ' min');
            } else {
                const remHours = Math.floor(estimatedMinutes / 60);
                const remMins = Math.ceil(estimatedMinutes % 60);
                $('#remainingTime').text(remHours + 'h ' + remMins + 'm');
            }
        }
    }
    
    // Add entry to processing log
    function addLogEntry(type, message) {
        const timestamp = new Date().toLocaleTimeString();
        const badgeClass = type === 'success' ? 'success' : 
                          type === 'warning' ? 'warning' : 
                          type === 'danger' ? 'danger' : 'info';
        
        const entry = `
            <div class="log-entry mb-1">
                <span class="badge bg-${badgeClass}">${timestamp}</span>
                <span class="ms-2">${message}</span>
            </div>
        `;
        
        $('#processingLog').prepend(entry);
        
        // Keep only last 50 entries
        $('.log-entry:gt(49)').remove();
    }
    
    // Show results
    function showResults(data) {
        $('#progressSection').hide();
        $('#resultsSection').show();
        
        const finalStats = `
            <div class="row">
                <div class="col-md-3">
                    <strong>Total Routes:</strong> ${data.total || 0}
                </div>
                <div class="col-md-3">
                    <strong>Processed:</strong> <span class="text-success">${data.processed || 0}</span>
                </div>
                <div class="col-md-3">
                    <strong>Skipped:</strong> <span class="text-warning">${data.skipped || 0}</span>
                </div>
                <div class="col-md-3">
                    <strong>Failed:</strong> <span class="text-danger">${data.failed || 0}</span>
                </div>
            </div>
            <div class="mt-3">
                <strong>Total Processing Time:</strong> ${$('#elapsedTime').text()}
            </div>
            <div class="mt-2">
                <strong>Average Speed:</strong> ${$('#processingSpeed').text()}
            </div>
        `;
        
        $('#finalStats').html(finalStats);
    }
    
    // Show error
    function showError(message) {
        $('#uploadForm').hide();
        $('#progressSection').hide();
        $('#resultsSection').hide();
        $('#errorSection').show();
        
        $('#errorMessage').text(message);
    }
    
    // Cancel button
    $('#cancelBtn').on('click', function() {
        if (confirm('Are you sure you want to cancel the upload?')) {
            clearInterval(uploadInterval);
            clearInterval(apiStatsInterval);
            
            if (currentUploadId) {
                $.ajax({
                    url: `/api/upload/cancel/${currentUploadId}`,
                    method: 'POST',
                    success: function() {
                        addLogEntry('warning', 'Upload cancelled by user');
                        setTimeout(() => location.reload(), 2000);
                    }
                });
            } else {
                location.reload();
            }
        }
    });
    
    // Upload another button
    $('#uploadAnotherBtn').on('click', function() {
        location.reload();
    });
    
    // Retry button
    $('#retryBtn').on('click', function() {
        location.reload();
    });
    
    // Pause button (for future implementation)
    $('#pauseBtn').on('click', function() {
        isPaused = !isPaused;
        if (isPaused) {
            $(this).html('<i class="fas fa-play"></i> Resume Processing');
            addLogEntry('warning', 'Processing paused');
        } else {
            $(this).html('<i class="fas fa-pause"></i> Pause Processing');
            addLogEntry('info', 'Processing resumed');
        }
    });
});
</script>
{% endblock %}